<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Pragyan CMS: cms/login.lib.php File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>cms/login.lib.php File Reference</h1>  </div>
</div>
<div class="contents">

<p><a href="login_8lib_8php_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">namespace &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacepragyan.html">pragyan</a></td></tr>

<p><tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight"><p>Widget Framework for Pragyan CMS  (c) 2010 Pragyan Team  <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a> GNU Public License For more details, see README  Add support for File Upload/Download via the widget's configurations  Reload Widgets ,Get Widget Instances. see bottom. </p>
<br/></td></tr>
</p>
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="login_8lib_8php.html#ad9c9ef516036820377d4a1ce00bc7558">resetPasswd</a> ($allow_login)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="login_8lib_8php.html#ac5685fd0874effc5066c668d1a69ed4f">openid_endpoint</a> ($openid_url)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="login_8lib_8php.html#aac74430b0cf0c8aa0ec501c3a627ac6e">openid_login</a> ($userdata)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="login_8lib_8php.html#accf4237ced682541fae5999e93efe9e0">loginForm</a> ($allow_login=1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="login_8lib_8php.html#aa311da27ba5706f5710cea7706c8eae1">login</a> ()</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aa311da27ba5706f5710cea7706c8eae1"></a><!-- doxytag: member="login.lib.php::login" ref="aa311da27ba5706f5710cea7706c8eae1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">login </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Function. Basically performs the whole login routine </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000002">Todo:</a></b></dt><dd>Document it </dd></dl>

<p>Definition at line <a class="el" href="login_8lib_8php_source.html#l00531">531</a> of file <a class="el" href="login_8lib_8php_source.html">login.lib.php</a>.</p>

</div>
</div>
<a class="anchor" id="accf4237ced682541fae5999e93efe9e0"></a><!-- doxytag: member="login.lib.php::loginForm" ref="accf4237ced682541fae5999e93efe9e0" args="($allow_login=1)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">loginForm </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>allow_login</em> = <code>1</code></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="login_8lib_8php_source.html#l00427">427</a> of file <a class="el" href="login_8lib_8php_source.html">login.lib.php</a>.</p>

</div>
</div>
<a class="anchor" id="ac5685fd0874effc5066c668d1a69ed4f"></a><!-- doxytag: member="login.lib.php::openid_endpoint" ref="ac5685fd0874effc5066c668d1a69ed4f" args="($openid_url)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">openid_endpoint </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>openid_url</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>This function takes the OpenID given by the user and try to find out the final endpoint by parsing the OpenID URL. It will check if the OpenID URL supplied is a valid URL or not. OpenID is stored in $_SESSION['openid_url'] for later use. It Uses the <a class="el" href="class_dope___open_i_d.html">Dope_OpenID</a> class found in cms/openid/. After the Endpoint URL has being found out, this function redirects the user to the OpenID provider's website for authentication </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$openid_url</em>&nbsp;</td><td>The OpenID of the user as string. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Nothing </dd></dl>

<p><p>If running PHP 5, use the built-in URL validator. Else use something like the following regex to validate input.</p>
<p>Proceed if we made it through without setting $error</p>
<p>Store the user's submitted OpenID Identity for later use.</p>
<p>Create a new <a class="el" href="class_dope___open_i_d.html">Dope_OpenID</a> object</p>
<p>ReturnURL: The URL to which the OpenID provider should return the user to, after the authentication has been done. This Line might require editing: The user's OpenID provider will return them to the URL that you provide here.</p>
<p>if rewriteEngine is enabled, then write explicit name index.php (direct filename are saved from being processed by rewrite engine) since rewriteEngine is poorly coded. It doesn't allow longer GET queries. if rewriteEngine is off, we can remove the index.php part to make the url look non-php</p>
<p>TrustRoot: The URL to which your user would be asked to trust. This is usually the parent directory of ReturnURL Set the trust root. This is the URL or set of URLs the user will be asked to trust when signing in with their OpenID Provider. It could be your base URL or a subdirectory thereof. Up to you.</p>
<p>OptionalInfo: The information you need to fetch form the Provider When the user signs in with their OpenID Provider, these are the details you would like sent back for your own use. Dope OpenID attempts to get this information using both Simple Registration and Attribute Exchange protocols. The type that is returned depends on the user's Provider. Each provider chooses what they wish to provide and all defined attributes may not be available. To see where these two types of attributes intersect, see the following: <a href="http://www.axschema.org/types/">http://www.axschema.org/types/</a></p>
<p>EDIT THIS LINE (OPTIONAL) PAPE Policies help protect users and you against phishing and other authentication forgeries. It's an optional extension, so not all OpenID Providers will be using it. Uncomment to use it. More info and possible policy values here: <a href="http://openid.net/specs/openid-provider-authentication-policy-extension-1_0-01.html">http://openid.net/specs/openid-provider-authentication-policy-extension-1_0-01.html</a></p>
<p>EDIT THIS LINE (OPTIONAL) Also part of the PAPE extension, you can set a time limit for users to authenticate themselves with their OpenID Provider. If it takes too long, authentication will fail and the user will not be allowed access to your site. Uncomment and set a value in seconds to use.</p>
<p>Attempt to discover the user's OpenID provider endpoint</p>
<p>If we find the endpoint, you might want to store it for later use.</p>
<p>Redirect the user to their OpenID Provider</p>
<p>Call exit so the script stops executing while we wait to redirect.</p>
<p>Else we couldn't find an OpenID Provider endpoint for the user. You can report this error any way you like. but just for demonstration purposes we'll get the error as reported by Dope OpenID. It will be displayed farther down in this file with the HTML.</p>
</p>

<p>Definition at line <a class="el" href="login_8lib_8php_source.html#l00123">123</a> of file <a class="el" href="login_8lib_8php_source.html">login.lib.php</a>.</p>

</div>
</div>
<a class="anchor" id="aac74430b0cf0c8aa0ec501c3a627ac6e"></a><!-- doxytag: member="login.lib.php::openid_login" ref="aac74430b0cf0c8aa0ec501c3a627ac6e" args="($userdata)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">openid_login </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>userdata</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Performs the actual openid login once the authentication has been confirmed from the Provider. Basically deals with four cases: 1. The user has used this OpenID before: This means that this OpenID entry is there in the _openid_users table and thus the user has previously used this OpenID before. In such case, the authentication is done and the user logs in. 2. When the OpenID provider didn't returned the user's email address: We currently do not support such OpenID provider, and thus an error message is recieved by the user. 3. When OpenID provider returns an Email which is already there in our records: This means that the user of this OpenID is already being registered also as a normal Pragyan User (or other OpenID user). The main thing is that the there is an entry for this particular EmailID in _users table. When this happens, user is asked to give the password of the pre-existing account at the PragyanCMS so that it can be linked to this OpenID </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000001">Todo:</a></b></dt><dd>Check what happen if the entry in _users is because of another OpenID entry and not because of a Pragyan user. I suspect that the code will still ask for the password (which it shouldn't). The code shouldn't check Pre-existing email ID for those entries which have login_method as openid. 4. When OpenID proovider returns an Email which is not there in our records: In this case, the system demands the user to give their full name and thus it registers themselves as a dummy openid user in _users (with login_method = openid) and create entries in _openid_users too. After this, the user can start using his account.</dd></dl>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>$userdata</em>&nbsp;</td><td>user information returned by the OpenID provider. Can be fetched by the -&gt;filteruserinfo() function in DopeOpenID class </td></tr>
  </table>
  </dd>
</dl>

<p><p>Build a query to check if the OpenID already exits in openid_users table</p>
<p>the record exists, this user has already used his OpenID before</p>
<p>Fetch the user_id that corresponds to user_id in the _users table</p>
<p>the OpenID provider did sent us the email of the user. Check if it exists in our database and is activated</p>
<p>ASSUMPTION : the `user_activated' column in _users table is 1 if and only if his email is verified.</p>
<p>Assign the value to $_SESSION['last_to_last_login_datetime']</p>
<p>update the last login</p>
<p>logging in the user</p>
<p>This user is first time using the OpenID display a small form to input User's Details System should now check if the email ID is provided by the openID provider is already there in Our records. If yes, the current account should be linked up to the account in the database after accepting the password. Else, User should provide few details about him/her like Full name, and Email. Now after he provides the email, The System again has to check if the email is under records and if it is, ask the password from user to link it else, just make a new user in table _users</p>
<p>the OpenID provider did sent us the email of the user. Check if it exists in our database and is activated</p>
<p>ASSUMPTION : the `user_activated' column in _users table is 1 if and only if his email is verified.</p>
<p>if the Email was found in the records Display a Form to capture the Password and connect it</p>
<p>User have not used this OpenID before. The EmailID returned wasn't found in our records. Hence now we will have to get the full name of the user and then create a dummy user in _users table with the login_method as `openid'. Then we also have to make entries in the _openid_users table and add the user there appropriately.</p>
<p>The OpenID provider didn't sent us the Email. Tell the user that he can't authenticate using such providers</p>
</p>

<p>Definition at line <a class="el" href="login_8lib_8php_source.html#l00266">266</a> of file <a class="el" href="login_8lib_8php_source.html">login.lib.php</a>.</p>

</div>
</div>
<a class="anchor" id="ad9c9ef516036820377d4a1ce00bc7558"></a><!-- doxytag: member="login.lib.php::resetPasswd" ref="ad9c9ef516036820377d4a1ce00bc7558" args="($allow_login)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">resetPasswd </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"> <em>allow_login</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="login_8lib_8php_source.html#l00016">16</a> of file <a class="el" href="login_8lib_8php_source.html">login.lib.php</a>.</p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Jan 2 2011 04:55:32 for Pragyan CMS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
