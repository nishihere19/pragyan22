<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Pragyan CMS: cms/modules/quiz/simplequiz.php Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>cms/modules/quiz/simplequiz.php</h1>  </div>
</div>
<div class="contents">
<a href="simplequiz_8php.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 &lt;?php
<a name="l00002"></a>00002 <span class="keywordflow">if</span>(!defined(<span class="stringliteral">&#39;__PRAGYAN_CMS&#39;</span>))
<a name="l00003"></a>00003 { 
<a name="l00004"></a>00004         header($_SERVER[<span class="stringliteral">&#39;SERVER_PROTOCOL&#39;</span>].<span class="stringliteral">&#39; 403 Forbidden&#39;</span>);
<a name="l00005"></a>00005         echo <span class="stringliteral">&quot;&lt;h1&gt;403 Forbidden&lt;h1&gt;&lt;h4&gt;You are not authorized to access the page.&lt;/h4&gt;&quot;</span>;
<a name="l00006"></a>00006         echo <span class="stringliteral">&#39;&lt;hr/&gt;&#39;</span>.$_SERVER[<span class="stringliteral">&#39;SERVER_SIGNATURE&#39;</span>];
<a name="l00007"></a>00007         exit(1);
<a name="l00008"></a>00008 }
<a name="l00009"></a>00009 <span class="comment">/*</span>
<a name="l00010"></a>00010 <span class="comment"> * Created on Jan 15, 2009</span>
<a name="l00011"></a>00011 <span class="comment"> */</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="comment">// SSO: optAnswer{SectionId}_{QuestionId} =&gt; value (OptionId)</span>
<a name="l00014"></a>00014 <span class="comment">// MSO: chkAnswer{SectionId}_{QuestionId}_{OptionId}</span>
<a name="l00015"></a>00015 <span class="comment">// Subj: txtAnswer{SectionId}_{QuestionId}</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="simplequiz_8php.html#a6f5650fbfee309973c44f8615221b572">00018</a> define(<span class="stringliteral">&#39;QUIZ_COMPLETED&#39;</span>, 1);
<a name="l00019"></a><a class="code" href="simplequiz_8php.html#aa992cf973dae7b8c71fdaa3fb56ba2da">00019</a> define(<span class="stringliteral">&#39;QUIZ_SUBMISSIONFAILED&#39;</span>, <span class="keyword">false</span>);
<a name="l00020"></a><a class="code" href="simplequiz_8php.html#ae6fa5953b4bcf6c46db909cb865624cb">00020</a> define(<span class="stringliteral">&#39;QUIZ_SUBMISSIONSUCCESSFUL&#39;</span>, <span class="keyword">true</span>);
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="simplequiz_8php.html#a51cb481560d9640a26e0e4285c1d0696">00022</a> define(<span class="stringliteral">&#39;QUIZ_TIMEOUT_ERRORMSG&#39;</span>, <span class="stringliteral">&#39;You have run out of time for this quiz. Your test will be evaluated only for the answers you have submitted previously.&#39;</span>);
<a name="l00023"></a><a class="code" href="simplequiz_8php.html#afcfcbf8cabaa8e2eedcd6726d70d13fa">00023</a> define(<span class="stringliteral">&#39;QUIZ_SECTION_TIMEOUT_ERRORMSG&#39;</span>, <span class="stringliteral">&#39;You have run out of time for this section. Only the answers that you have submitted previously will be evaluated. You can still view sections for which you have time left from the &lt;a href=&quot;./+view&quot;&gt;Quiz main page&lt;/a&gt;.&#39;</span>);
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="class_simple_quiz.html">00025</a> <span class="keyword">class </span><a class="code" href="class_simple_quiz.html">SimpleQuiz</a> <span class="keyword">implements</span> <a class="code" href="interface_i_quiz.html">IQuiz</a> {
<a name="l00026"></a>00026         <span class="keyword">private</span> $quizId;
<a name="l00027"></a>00027         <span class="keyword">private</span> $quizRow;
<a name="l00028"></a>00028 
<a name="l00029"></a><a class="code" href="class_simple_quiz.html#a833185e116ad6ac55c94b170ad539a2b">00029</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a833185e116ad6ac55c94b170ad539a2b">__construct</a>($quizId) {
<a name="l00030"></a>00030                 $this-&gt;quizId = $quizId;
<a name="l00031"></a>00031                 $this-&gt;quizRow = <a class="code" href="quizedit_8php.html#a6ada0f11ace918713dcac4ea90d7c6fd">getQuizRow</a>($quizId);
<a name="l00032"></a>00032         }
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="class_simple_quiz.html#a01fbb6b5962a1772e95a20442326240d">00034</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a01fbb6b5962a1772e95a20442326240d">getPropertiesForm</a>($dataSource) {
<a name="l00035"></a>00035                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;No quiz specific properties.&#39;</span>;
<a name="l00036"></a>00036         }
<a name="l00037"></a>00037 
<a name="l00038"></a><a class="code" href="class_simple_quiz.html#ad52bd7d21b51da71792287c35d11d7a0">00038</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#ad52bd7d21b51da71792287c35d11d7a0">submitPropertiesForm</a>() {
<a name="l00039"></a>00039                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00040"></a>00040         }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getSectionStartForm($sectionId) {
<a name="l00043"></a>00043                 <span class="keywordflow">return</span> &lt;&lt;&lt;SECTIONSTARTFORM
<a name="l00044"></a>00044                         &lt;<a class="code" href="classform.html">form</a> <a class="code" href="template_8lib_8php.html#a824aa20276005f0889ccb9ff6f1c5efd">name</a>=<span class="stringliteral">&quot;sectionstartform&quot;</span> method=<span class="stringliteral">&quot;POST&quot;</span> action=<span class="stringliteral">&quot;./+view&quot;</span> style=<span class="stringliteral">&quot;padding:0;margin:0;display:inline&quot;</span>&gt;
<a name="l00045"></a>00045                                 &lt;input <a class="code" href="cms_2templates_2blue__banks_2index_8php.html#a5b4586081f28ba5c2b7326fc2d4ca512">type</a>=<span class="stringliteral">&quot;hidden&quot;</span> name=<span class="stringliteral">&quot;hdnSectionId&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;hdnSectionId&quot;</span> value=<span class="stringliteral">&quot;$sectionId&quot;</span> /&gt;
<a name="l00046"></a>00046                                 &lt;input type=<span class="stringliteral">&quot;submit&quot;</span> name=<span class="stringliteral">&quot;btnStartSection&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;btnStartSection&quot;</span> value=<span class="stringliteral">&quot;Start&quot;</span> /&gt;
<a name="l00047"></a>00047                         &lt;/<a class="code" href="classform.html">form</a>&gt;
<a name="l00048"></a>00048 SECTIONSTARTFORM;
<a name="l00049"></a>00049         }
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="class_simple_quiz.html#a7ca3c055d774e3670368f2815d5d0222">00051</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a7ca3c055d774e3670368f2815d5d0222">getFrontPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00052"></a>00052                 $frontPage = <span class="stringliteral">&quot;&lt;h2&gt;{$this-&gt;quizRow[&#39;quiz_title&#39;]}&lt;/h2&gt;\n&quot;</span>;
<a name="l00053"></a>00053                 $frontPage .= <span class="stringliteral">&quot;&lt;div class=\&quot;quiz_headertext\&quot;&gt;{$this-&gt;quizRow[&#39;quiz_headertext&#39;]}&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;\n&quot;</span>;
<a name="l00054"></a>00054                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>]) {
<a name="l00055"></a>00055                         $sectionList = <a class="code" href="quizedit_8php.html#aa6048c9e9a7e86f07a5099a0cf660bd3">getSectionList</a>($this-&gt;quizId);
<a name="l00056"></a>00056                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($sectionList); ++$i) {
<a name="l00057"></a>00057                                 $frontPage .= <span class="stringliteral">&#39;&lt;strong&gt;&#39;</span> . $sectionList[$i][<span class="stringliteral">&#39;quiz_sectiontitle&#39;</span>] . <span class="stringliteral">&#39;&lt;/strong&gt; &#39;</span>;
<a name="l00058"></a>00058                                 $attemptRow = <a class="code" href="quizview_8php.html#a52a9a44d1bab5deac59f0d01c102a48e">getAttemptRow</a>($this-&gt;quizId, $sectionList[$i][<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], <a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00059"></a>00059                                 <span class="keywordflow">if</span> (!$attemptRow || is_null($attemptRow[<span class="stringliteral">&#39;quiz_attemptstarttime&#39;</span>])) {
<a name="l00060"></a>00060                                         <span class="comment">// User hasn&#39;t started this section yet.</span>
<a name="l00061"></a>00061                                         $frontPage .= $this-&gt;getSectionStartForm($sectionList[$i][<span class="stringliteral">&#39;quiz_sectionid&#39;</span>]);
<a name="l00062"></a>00062                                 }
<a name="l00063"></a>00063                                 elseif (is_null($attemptRow[<span class="stringliteral">&#39;quiz_submissiontime&#39;</span>])) {
<a name="l00064"></a>00064                                         <span class="comment">// User hasn&#39;t finished this section yet.</span>
<a name="l00065"></a>00065                                         $frontPage .= <span class="stringliteral">&#39; &lt;a href=&quot;./+view&amp;sectionid=&#39;</span> . $sectionList[$i][<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="stringliteral">&#39;&quot;&gt;Go to questions&lt;/a&gt;&#39;</span>;
<a name="l00066"></a>00066                                 }
<a name="l00067"></a>00067                                 <span class="keywordflow">else</span> {
<a name="l00068"></a>00068                                         <span class="comment">// User has finished the section already.</span>
<a name="l00069"></a>00069                                         $frontPage .= <span class="stringliteral">&quot; Section Completed.&quot;</span>;
<a name="l00070"></a>00070                                 }
<a name="l00071"></a>00071                                 $frontPage .= <span class="stringliteral">&#39;&lt;br /&gt;&lt;br /&gt;&#39;</span>;
<a name="l00072"></a>00072                         }
<a name="l00073"></a>00073                 }
<a name="l00074"></a>00074                 <span class="keywordflow">else</span> {
<a name="l00075"></a>00075                         $frontPage .= &lt;&lt;&lt;QUIZSTARTFORM
<a name="l00076"></a>00076                         &lt;<a class="code" href="classform.html">form</a> <a class="code" href="template_8lib_8php.html#a824aa20276005f0889ccb9ff6f1c5efd">name</a>=<span class="stringliteral">&quot;quizstartform&quot;</span> method=<span class="stringliteral">&quot;POST&quot;</span> action=<span class="stringliteral">&quot;./+view&quot;</span> style=<span class="stringliteral">&quot;padding:0;margin:0;display:inline&quot;</span>&gt;
<a name="l00077"></a>00077                                 &lt;input <a class="code" href="cms_2templates_2blue__banks_2index_8php.html#a5b4586081f28ba5c2b7326fc2d4ca512">type</a>=<span class="stringliteral">&quot;submit&quot;</span> name=<span class="stringliteral">&quot;btnStartQuiz&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;btnStartQuiz&quot;</span> value=<span class="stringliteral">&quot;Start&quot;</span> /&gt;
<a name="l00078"></a>00078                         &lt;/<a class="code" href="classform.html">form</a>&gt;
<a name="l00079"></a>00079 QUIZSTARTFORM;
<a name="l00080"></a>00080                 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082                 <span class="keywordflow">return</span> $frontPage;
<a name="l00083"></a>00083         }
<a name="l00084"></a>00084 
<a name="l00091"></a><a class="code" href="class_simple_quiz.html#a7b19ee4ec28a70110645246f72170767">00091</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a7b19ee4ec28a70110645246f72170767">getQuizPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00092"></a>00092                 <span class="keywordflow">if</span> ($this-&gt;checkQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>)) {
<a name="l00093"></a>00093                         <a class="code" href="common_8lib_8php.html#aa3cfe8c6012285f143bc8aff8cd4a12d">displayinfo</a>(<span class="stringliteral">&#39;You seem to have completed this quiz already. You can only take this quiz once.&#39;</span>);
<a name="l00094"></a>00094                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00095"></a>00095                 }
<a name="l00096"></a>00096 
<a name="l00097"></a>00097                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>]) {
<a name="l00098"></a>00098                         <span class="comment">// if btnStartSection and hdnSectionId are set</span>
<a name="l00099"></a>00099                         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;btnStartSection&#39;</span>]) &amp;&amp; $this-&gt;isValidId($_POST[<span class="stringliteral">&#39;hdnSectionId&#39;</span>]) &amp;&amp; <a class="code" href="quizview_8php.html#aef436f4f5368ce3bc5ec759da4d43204">sectionBelongsToQuiz</a>($this-&gt;quizId, $_POST[<span class="stringliteral">&#39;hdnSectionId&#39;</span>]))
<a name="l00100"></a>00100                                 $sectionId = intval($_POST[<span class="stringliteral">&#39;hdnSectionId&#39;</span>]);
<a name="l00101"></a>00101                         elseif (isset($_GET[<span class="stringliteral">&#39;sectionid&#39;</span>]) &amp;&amp; $this-&gt;isValidId($_GET[<span class="stringliteral">&#39;sectionid&#39;</span>]))
<a name="l00102"></a>00102                                 $sectionId = intval($_GET[<span class="stringliteral">&#39;sectionid&#39;</span>]);
<a name="l00103"></a>00103 
<a name="l00104"></a>00104                         <span class="keywordflow">if</span> (!isset($sectionId))
<a name="l00105"></a>00105                                 <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_simple_quiz.html#a7ca3c055d774e3670368f2815d5d0222">getFrontPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                         $attemptRow = <a class="code" href="quizview_8php.html#a52a9a44d1bab5deac59f0d01c102a48e">getAttemptRow</a>($this-&gt;quizId, $sectionId, <a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00108"></a>00108                         $sectionStarted = $attemptRow ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00109"></a>00109                         $sectionCompleted = !is_null($attemptRow[<span class="stringliteral">&#39;quiz_submissiontime&#39;</span>]);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111                         <span class="keywordflow">if</span> (!$sectionStarted) {
<a name="l00112"></a>00112                                 <span class="keywordflow">if</span> (!isset($_POST[<span class="stringliteral">&#39;btnStartSection&#39;</span>])) {
<a name="l00113"></a>00113                                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Error. You have not started this section yet. Please go to the quiz main page, and click on the Start Section button to view this section.&#39;</span>);
<a name="l00114"></a>00114                                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00115"></a>00115                                 }
<a name="l00116"></a>00116                                 <span class="keywordflow">if</span> (!<a class="code" href="quizview_8php.html#aaa6d275d2d6b9dcc71b64471ad66ba04">startSection</a>($this-&gt;quizId, $sectionId, <a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>))
<a name="l00117"></a>00117                                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00118"></a>00118                         }
<a name="l00119"></a>00119                         elseif ($sectionCompleted) {
<a name="l00120"></a>00120                                 <a class="code" href="common_8lib_8php.html#aa3cfe8c6012285f143bc8aff8cd4a12d">displayinfo</a>(<span class="stringliteral">&quot;You have completed this section.&quot;</span>);
<a name="l00121"></a>00121                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00122"></a>00122                         }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124                         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;btnSubmit&#39;</span>])) {
<a name="l00125"></a>00125                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_simple_quiz.html#ac3bf8d63d13cbc3e3e1f90c6a1cd0a35">submitQuizPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) === <span class="keyword">true</span>) {
<a name="l00126"></a>00126                                         <span class="keywordflow">if</span> ($this-&gt;markSectionCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId)) {
<a name="l00127"></a>00127                                                 <span class="comment">// This section has been completed. See if the quiz also got completed</span>
<a name="l00128"></a>00128                                                 <span class="keywordflow">if</span> ($this-&gt;checkQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>)) {
<a name="l00129"></a>00129                                                         <span class="keywordflow">return</span> $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_submittext&#39;</span>];
<a name="l00130"></a>00130                                                 }
<a name="l00131"></a>00131                                                 <span class="keywordflow">else</span> {
<a name="l00132"></a>00132                                                         <a class="code" href="common_8lib_8php.html#aa3cfe8c6012285f143bc8aff8cd4a12d">displayinfo</a>(<span class="stringliteral">&#39;You have completed this section. You can move to another section.&#39;</span>);
<a name="l00133"></a>00133                                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_simple_quiz.html#a7ca3c055d774e3670368f2815d5d0222">getFrontPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00134"></a>00134                                                 }
<a name="l00135"></a>00135                                         }
<a name="l00136"></a>00136                                         <span class="keywordflow">else</span>
<a name="l00137"></a>00137                                                 <a class="code" href="common_8lib_8php.html#aa3cfe8c6012285f143bc8aff8cd4a12d">displayinfo</a>(<span class="stringliteral">&#39;Your previous page was submitted successfully.&#39;</span>);
<a name="l00138"></a>00138                                 }
<a name="l00139"></a>00139                         }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141                         <span class="comment">// TODO: Put in time check here</span>
<a name="l00142"></a>00142                         <span class="keywordflow">if</span> ($this-&gt;checkUserTimedOut(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>)) {
<a name="l00143"></a>00143                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<a class="code" href="simplequiz_8php.html#a51cb481560d9640a26e0e4285c1d0696">QUIZ_TIMEOUT_ERRORMSG</a>);
<a name="l00144"></a>00144                                 $this-&gt;forceQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00145"></a>00145                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00146"></a>00146                         }
<a name="l00147"></a>00147                         elseif ($this-&gt;checkUserTimedOut(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId)) {
<a name="l00148"></a>00148                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<a class="code" href="simplequiz_8php.html#afcfcbf8cabaa8e2eedcd6726d70d13fa">QUIZ_SECTION_TIMEOUT_ERRORMSG</a>);
<a name="l00149"></a>00149                                 $this-&gt;forceQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId);
<a name="l00150"></a>00150                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00151"></a>00151                         }
<a name="l00152"></a>00152 
<a name="l00153"></a>00153                         <span class="keywordflow">return</span> $this-&gt;formatNextPage(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId);
<a name="l00154"></a>00154                 }
<a name="l00155"></a>00155                 <span class="keywordflow">else</span> {
<a name="l00156"></a>00156                         <span class="comment">// if quiz is already started, show next page</span>
<a name="l00157"></a>00157                         <span class="comment">// else, see if btnStartQuiz is set, if yes, mark quiz as started, and show next page</span>
<a name="l00158"></a>00158 
<a name="l00159"></a>00159                         <span class="comment">// to mark a user&#39;s quiz as started, we insert one entry for each section in the quiz into user_attempts</span>
<a name="l00160"></a>00160                         <span class="comment">// to see if the user&#39;s quiz has been started, we see if there is a row in user_attempts with section id 1</span>
<a name="l00161"></a>00161                         $minSectionId = <a class="code" href="quizview_8php.html#a6544ad361cff60a7a53d87bce58e4b38">getFirstSectionId</a>($this-&gt;quizId);
<a name="l00162"></a>00162                         $attemptRow = <a class="code" href="quizview_8php.html#a52a9a44d1bab5deac59f0d01c102a48e">getAttemptRow</a>($this-&gt;quizId, $minSectionId, <a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00163"></a>00163 
<a name="l00164"></a>00164                         <span class="keywordflow">if</span> (!$attemptRow) {
<a name="l00165"></a>00165                                 <span class="keywordflow">if</span> (!isset($_POST[<span class="stringliteral">&#39;btnStartQuiz&#39;</span>]))
<a name="l00166"></a>00166                                         <span class="keywordflow">return</span> $this-&gt;<a class="code" href="class_simple_quiz.html#a7ca3c055d774e3670368f2815d5d0222">getFrontPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00167"></a>00167 
<a name="l00168"></a>00168                                 <span class="comment">// ok, btnStartQuiz was set, and the quiz wasn&#39;t started already,</span>
<a name="l00169"></a>00169                                 <span class="comment">// start it by inserting a row for each section in the quiz into quiz_userattempts.</span>
<a name="l00170"></a>00170                                 $attemptQuery = <span class="stringliteral">&quot;INSERT INTO `quiz_userattempts`(`page_modulecomponentid`, `quiz_sectionid`, `user_id`, `quiz_attemptstarttime`) &quot;</span> .
<a name="l00171"></a>00171                                                 <span class="stringliteral">&quot;SELECT {$this-&gt;quizId}, `quiz_sectionid`, $userId, NOW() FROM `quiz_sections` WHERE `page_modulecomponentid` = {$this-&gt;quizId}&quot;</span>;
<a name="l00172"></a>00172                                 <span class="keywordflow">if</span> (!mysql_query($attemptQuery)) {
<a name="l00173"></a>00173                                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not update quiz information.&#39;</span>);
<a name="l00174"></a>00174                                         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00175"></a>00175                                 }
<a name="l00176"></a>00176                         }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178                         <span class="keywordflow">if</span> (isset($_POST[<span class="stringliteral">&#39;btnSubmit&#39;</span>])) {
<a name="l00179"></a>00179                                 <span class="keywordflow">if</span> ($this-&gt;<a class="code" href="class_simple_quiz.html#ac3bf8d63d13cbc3e3e1f90c6a1cd0a35">submitQuizPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) == <span class="keyword">true</span>) {
<a name="l00180"></a>00180                                         <span class="keywordflow">if</span> ($this-&gt;markSectionCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, -1)) {
<a name="l00181"></a>00181                                                 <span class="keywordflow">if</span> ($this-&gt;checkQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>))
<a name="l00182"></a>00182                                                         <span class="keywordflow">return</span> $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_submittext&#39;</span>];
<a name="l00183"></a>00183                                         }
<a name="l00184"></a>00184                                         <span class="keywordflow">else</span>
<a name="l00185"></a>00185                                                 <a class="code" href="common_8lib_8php.html#aa3cfe8c6012285f143bc8aff8cd4a12d">displayinfo</a>(<span class="stringliteral">&#39;Your previous page was submitted successfully.&#39;</span>);
<a name="l00186"></a>00186                                 }
<a name="l00187"></a>00187                         }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189                         <span class="comment">// TODO: Put in time check here</span>
<a name="l00190"></a>00190                         <span class="keywordflow">if</span> ($this-&gt;checkUserTimedOut(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>)) {
<a name="l00191"></a>00191                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<a class="code" href="simplequiz_8php.html#a51cb481560d9640a26e0e4285c1d0696">QUIZ_TIMEOUT_ERRORMSG</a>);
<a name="l00192"></a>00192                                 $this-&gt;forceQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00193"></a>00193                                 <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00194"></a>00194                         }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                         <span class="keywordflow">return</span> $this-&gt;formatNextPage(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00197"></a>00197                 }
<a name="l00198"></a>00198         }
<a name="l00199"></a>00199 
<a name="l00205"></a><a class="code" href="class_simple_quiz.html#ac3bf8d63d13cbc3e3e1f90c6a1cd0a35">00205</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#ac3bf8d63d13cbc3e3e1f90c6a1cd0a35">submitQuizPage</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00206"></a>00206                 <span class="comment">// get all the questions that have been shown to the user</span>
<a name="l00207"></a>00207                 <span class="comment">// get the submitted answer for all of these questions, and insert them into the db</span>
<a name="l00208"></a>00208                 $questionQuery = <span class="stringliteral">&quot;SELECT `quiz_questions`.`quiz_sectionid` AS `quiz_sectionid`, &quot;</span> .
<a name="l00209"></a>00209                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_questionid` AS `quiz_questionid`, &quot;</span> .
<a name="l00210"></a>00210                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_questiontype` AS `quiz_questiontype`, &quot;</span> .
<a name="l00211"></a>00211                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_answermaxlength` AS `quiz_answermaxlength` &quot;</span> .
<a name="l00212"></a>00212                                 <span class="stringliteral">&quot;FROM `quiz_answersubmissions`, `quiz_questions` WHERE &quot;</span> .
<a name="l00213"></a>00213                                 <span class="stringliteral">&quot;`quiz_questions`.`page_modulecomponentid` = `quiz_answersubmissions`.`page_modulecomponentid` AND &quot;</span> .
<a name="l00214"></a>00214                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_sectionid` = `quiz_answersubmissions`.`quiz_sectionid` AND &quot;</span> .
<a name="l00215"></a>00215                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_questionid` = `quiz_answersubmissions`.`quiz_questionid` AND &quot;</span> .
<a name="l00216"></a>00216                                 <span class="stringliteral">&quot;`quiz_questions`.`page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId AND &quot;</span> .
<a name="l00217"></a>00217                                 <span class="stringliteral">&quot;`quiz_questionviewtime` IS NOT NULL AND `quiz_answersubmittime` IS NULL &quot;</span>;
<a name="l00218"></a>00218                 <span class="keywordflow">if</span>($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>] == 1)
<a name="l00219"></a>00219                         $questionQuery .= <span class="stringliteral">&quot;AND `quiz_answersubmissions`.`quiz_sectionid` = {$_GET[&#39;sectionid&#39;]} &quot;</span>;
<a name="l00220"></a>00220                 $questionQuery .= <span class="stringliteral">&quot;ORDER BY `quiz_answersubmissions`.`quiz_questionrank` LIMIT {$this-&gt;quizRow[&#39;quiz_questionsperpage&#39;]}&quot;</span>;
<a name="l00221"></a>00221                 $questionResult = mysql_query($questionQuery);
<a name="l00222"></a>00222                 <span class="keywordflow">if</span> (!$questionResult) {
<a name="l00223"></a>00223                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Invalid query. &#39;</span> . $questionQuery . <span class="charliteral">&#39; &#39;</span> . mysql_error());
<a name="l00224"></a>00224                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00225"></a>00225                 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227                 <span class="comment">// Put in check about user&#39;s time elapsed here</span>
<a name="l00228"></a>00228                 <span class="keywordflow">if</span> ($this-&gt;checkUserTimedOut(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, -1, <span class="stringliteral">&#39;1 MINUTE&#39;</span>)) {
<a name="l00229"></a>00229                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Sorry, you have exceeded your time limit for the quiz. Your latest submission cannot be evaluated.&#39;</span>);
<a name="l00230"></a>00230                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00231"></a>00231                 }
<a name="l00232"></a>00232 
<a name="l00233"></a>00233                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>]) {
<a name="l00234"></a>00234                         $sectionId = intval($_GET[<span class="stringliteral">&#39;sectionid&#39;</span>]);
<a name="l00235"></a>00235                         <span class="keywordflow">if</span> ($this-&gt;checkUserTimedOut(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId, <span class="stringliteral">&#39;1 MINUTE&#39;</span>)) {
<a name="l00236"></a>00236                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Sorry, you have exceeded your time limit for this section. Your latest submission cannot be evaluated.&#39;</span>);
<a name="l00237"></a>00237                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00238"></a>00238                         }
<a name="l00239"></a>00239                 }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241                 $submittedAnswers = array();
<a name="l00242"></a>00242                 $rollbackQuery = array();
<a name="l00243"></a>00243                 <span class="keywordflow">while</span> ($questionRow = mysql_fetch_assoc($questionResult)) {
<a name="l00244"></a>00244                         $rollbackQuery[] = <span class="stringliteral">&quot;(`quiz_sectionid` = {$questionRow[&#39;quiz_sectionid&#39;]} AND `quiz_questionid` = {$questionRow[&#39;quiz_questionid&#39;]})&quot;</span>;
<a name="l00245"></a>00245                         $questionType = $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>];
<a name="l00246"></a>00246 
<a name="l00247"></a>00247                         <span class="keywordflow">if</span> (!isset($_POST[<span class="stringliteral">&#39;hdnQuestion&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>]])) {
<a name="l00248"></a>00248                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(
<a name="l00249"></a>00249                                         <span class="stringliteral">&#39;Error. The answers that you submitted do not match the list of questions you were shown. You may have refreshed the page, and resubmitted your previous page\&#39;s answers. &#39;</span> .
<a name="l00250"></a>00250                                         <span class="stringliteral">&#39;Please do not use the navigation buttons on your browser while taking the quiz.&#39;</span>
<a name="l00251"></a>00251                                 );
<a name="l00252"></a>00252                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00253"></a>00253                         }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255                         <span class="keywordflow">if</span> ($questionType == <span class="stringliteral">&#39;sso&#39;</span> || $questionType == <span class="stringliteral">&#39;mso&#39;</span>) {
<a name="l00256"></a>00256                                 $options = <a class="code" href="quizedit_8php.html#abbcd2bc9f89fbd603b8f510e6d122c32">getQuestionOptionList</a>($this-&gt;quizId, $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>]);
<a name="l00257"></a>00257                                 <span class="keywordflow">if</span> ($questionType == <span class="stringliteral">&#39;sso&#39;</span>) {
<a name="l00258"></a>00258                                         $fieldName = <span class="stringliteral">&#39;optAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>];
<a name="l00259"></a>00259                                         $submittedAnswer = isset($_POST[$fieldName]) &amp;&amp; is_numeric($_POST[$fieldName]) ? intval($_POST[$fieldName]) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00260"></a>00260                                         $optionFound = <span class="keyword">false</span>;
<a name="l00261"></a>00261                                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($options); ++$i) {
<a name="l00262"></a>00262                                                 <span class="keywordflow">if</span> ($options[$i][<span class="stringliteral">&#39;quiz_optionid&#39;</span>] == $submittedAnswer) {
<a name="l00263"></a>00263                                                         $submittedAnswers[] = array($questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>], $submittedAnswer);
<a name="l00264"></a>00264                                                         $optionFound = <span class="keyword">true</span>;
<a name="l00265"></a>00265                                                         <span class="keywordflow">break</span>;
<a name="l00266"></a>00266                                                 }
<a name="l00267"></a>00267                                         }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269                                         <span class="keywordflow">if</span> (!$optionFound)
<a name="l00270"></a>00270                                                 $submittedAnswers[] = array($questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>], <span class="stringliteral">&#39;&#39;</span>);
<a name="l00271"></a>00271                                 }
<a name="l00272"></a>00272                                 <span class="keywordflow">else</span> {
<a name="l00273"></a>00273                                         $submittedAnswer = array();
<a name="l00274"></a>00274                                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($options); ++$i) {
<a name="l00275"></a>00275                                                 $fieldName = <span class="stringliteral">&#39;chkAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $options[$i][<span class="stringliteral">&#39;quiz_optionid&#39;</span>];
<a name="l00276"></a>00276                                                 <span class="keywordflow">if</span> (isset($_POST[$fieldName]) &amp;&amp; is_numeric($_POST[$fieldName]))
<a name="l00277"></a>00277                                                         $submittedAnswer[] = intval($options[$i][<span class="stringliteral">&#39;quiz_optionid&#39;</span>]);
<a name="l00278"></a>00278                                         }
<a name="l00279"></a>00279                                         sort($submittedAnswer);
<a name="l00280"></a>00280                                         $submittedAnswers[] = array($questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>], implode(<span class="charliteral">&#39;|&#39;</span>, $submittedAnswer));
<a name="l00281"></a>00281                                 }
<a name="l00282"></a>00282                         }
<a name="l00283"></a>00283                         elseif ($questionType == <span class="stringliteral">&#39;subjective&#39;</span>) {
<a name="l00284"></a>00284                                 $fieldName = <span class="stringliteral">&#39;txtAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>];
<a name="l00285"></a>00285                                 $submittedAnswers[] = array($questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>], isset($_POST[$fieldName]) ? <a class="code" href="common_8lib_8php.html#a5c6bd309ef0f003235ad9fd0d90cc775">escape</a>($_POST[$fieldName]) : <span class="stringliteral">&#39;&#39;</span>);
<a name="l00286"></a>00286                         }
<a name="l00287"></a>00287                 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                 $rollbackQuery = <span class="stringliteral">&quot;UPDATE `quiz_answersubmissions` SET `quiz_answersubmittime` = NULL WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId AND (&quot;</span> . implode(<span class="stringliteral">&#39; OR &#39;</span>, $rollbackQuery) . <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00290"></a>00290                 <span class="keywordflow">for</span> ($i = 0; $i &lt; count($submittedAnswers); ++$i) {
<a name="l00291"></a>00291                         $updateQuery = <span class="stringliteral">&quot;UPDATE `quiz_answersubmissions` SET `quiz_submittedanswer` = &#39;{$submittedAnswers[$i][3]}&#39;, `quiz_answersubmittime` = NOW() WHERE &quot;</span> .
<a name="l00292"></a>00292                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = {$submittedAnswers[$i][0]} AND &quot;</span> .
<a name="l00293"></a>00293                                         <span class="stringliteral">&quot;`quiz_questionid` = {$submittedAnswers[$i][1]} AND `user_id` = $userId&quot;</span>;
<a name="l00294"></a>00294                         <span class="keywordflow">if</span> (!mysql_query($updateQuery)) {
<a name="l00295"></a>00295                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Invalid Query. Could not save answers.&#39;</span>);
<a name="l00296"></a>00296                                 mysql_query($rollbackQuery);
<a name="l00297"></a>00297                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00298"></a>00298                         }
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00302"></a>00302         }
<a name="l00303"></a>00303 
<a name="l00309"></a>00309         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> checkQuizInitialized(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00310"></a>00310                 $countQuery = <span class="stringliteral">&quot;SELECT COUNT(*) FROM `quiz_answersubmissions` WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00311"></a>00311                 $countResult = mysql_query($countQuery);
<a name="l00312"></a>00312                 
<a name="l00313"></a>00313                 $countRow = mysql_fetch_row($countResult);
<a name="l00314"></a>00314                 
<a name="l00315"></a>00315                 <span class="keywordflow">return</span> $countRow[0] == $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_questionspertest&#39;</span>];
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00323"></a><a class="code" href="class_simple_quiz.html#a133a73614130c4664be11da8be27aff2">00323</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a133a73614130c4664be11da8be27aff2">initQuiz</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00324"></a>00324                 <span class="comment">// a user is about to start the quiz</span>
<a name="l00325"></a>00325                 <span class="comment">// generate a list of questions, insert into quiz_answersubmissions, with answersubmittime = NULL</span>
<a name="l00326"></a>00326                 <span class="keywordflow">if</span> ($this-&gt;checkQuizInitialized(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>))
<a name="l00327"></a>00327                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                 $this-&gt;<a class="code" href="class_simple_quiz.html#a1ad6fd584ea4e71b01e4f55d0a0d5f29">deleteEntries</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00330"></a>00330                 $sectionList = <a class="code" href="quizedit_8php.html#aa6048c9e9a7e86f07a5099a0cf660bd3">getSectionList</a>($this-&gt;quizId);
<a name="l00331"></a>00331                 $questionList = array();
<a name="l00332"></a>00332                 $sections = array();
<a name="l00333"></a>00333                 <span class="keywordflow">for</span> ($i = 0; $i &lt; count($sectionList); ++$i) {
<a name="l00334"></a>00334                         $questionList[$i] = $this-&gt;getSectionQuestions($sectionList[$i]);
<a name="l00335"></a>00335                         <span class="keywordflow">for</span> ($j = 0; $j &lt; count($questionList[$i]); ++$j)
<a name="l00336"></a>00336                                 $sections[] = $i;
<a name="l00337"></a>00337                 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>] == 0 &amp;&amp; $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_mixsections&#39;</span>]) 
<a name="l00340"></a>00340                         shuffle($sections);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342                 $offsets = array_fill(0, count($questionList), 0);
<a name="l00343"></a>00343                 <span class="keywordflow">for</span> ($i = 0; $i &lt; count($sections); ++$i) {
<a name="l00344"></a>00344                         $insertQuery = <span class="stringliteral">&quot;INSERT INTO `quiz_answersubmissions`(`page_modulecomponentid`, `quiz_sectionid`, `quiz_questionid`, `user_id`, `quiz_questionrank`) VALUES&quot;</span> .
<a name="l00345"></a>00345                                         <span class="stringliteral">&quot;({$this-&gt;quizId}, {$sectionList[$sections[$i]][&#39;quiz_sectionid&#39;]}, {$questionList[$sections[$i]][$offsets[$sections[$i]]]}, $userId, $i)&quot;</span>;
<a name="l00346"></a>00346                         <span class="keywordflow">if</span> (!mysql_query($insertQuery)) {
<a name="l00347"></a>00347                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not initialize quiz.&#39;</span>);
<a name="l00348"></a>00348                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00349"></a>00349                         }
<a name="l00350"></a>00350                         $offsets[$sections[$i]]++;
<a name="l00351"></a>00351                 }
<a name="l00352"></a>00352                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354 
<a name="l00358"></a><a class="code" href="class_simple_quiz.html#a1ad6fd584ea4e71b01e4f55d0a0d5f29">00358</a>         <span class="keyword">public</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> <a class="code" href="class_simple_quiz.html#a1ad6fd584ea4e71b01e4f55d0a0d5f29">deleteEntries</a>(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00359"></a>00359                 $tableNames = array(<span class="stringliteral">&#39;quiz_userattempts&#39;</span>, <span class="stringliteral">&#39;quiz_answersubmissions&#39;</span>);
<a name="l00360"></a>00360                 $affectedRows = array();
<a name="l00361"></a>00361                 <span class="keywordflow">return</span> <a class="code" href="quizedit_8php.html#accb74038866692e9a3e725b6f0f8f942">deleteItem</a>($tableNames, <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>, $affectedRows);
<a name="l00362"></a>00362         }
<a name="l00363"></a>00363 
<a name="l00364"></a>00364         <span class="comment">// Utility Functions</span>
<a name="l00365"></a>00365         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getPageQuestions(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId = -1) {
<a name="l00366"></a>00366                 $questionsPerPage = $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_questionsperpage&#39;</span>];
<a name="l00367"></a>00367                 $questionQuery = <span class="stringliteral">&quot;SELECT `quiz_sectionid`, `quiz_questionid` FROM `quiz_answersubmissions` WHERE `user_id` = $userId AND `page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_answersubmittime` IS NULL &quot;</span>;
<a name="l00368"></a>00368                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>] == 1)
<a name="l00369"></a>00369                         $questionQuery .= <span class="stringliteral">&quot; AND `quiz_sectionid` = $sectionId &quot;</span>;
<a name="l00370"></a>00370                 $questionQuery .= <span class="stringliteral">&quot; ORDER BY `quiz_questionrank` LIMIT $questionsPerPage&quot;</span>;
<a name="l00371"></a>00371                 $questionResult = mysql_query($questionQuery);
<a name="l00372"></a>00372                 <span class="keywordflow">if</span> (!$questionResult) {
<a name="l00373"></a>00373                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not fetch questions.&#39;</span>);
<a name="l00374"></a>00374                         <span class="keywordflow">return</span> null;
<a name="l00375"></a>00375                 }
<a name="l00376"></a>00376                 $questionIds = array();
<a name="l00377"></a>00377                 <span class="keywordflow">while</span> ($questionRow = mysql_fetch_row($questionResult))
<a name="l00378"></a>00378                         $questionIds[] = $questionRow;
<a name="l00379"></a>00379                 <span class="keywordflow">return</span> $questionIds;
<a name="l00380"></a>00380         }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getTimerHtml(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId = -1) {
<a name="l00383"></a>00383                 $testElapsedTime = $this-&gt;getElapsedTime(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>);
<a name="l00384"></a>00384                 $testElapsedTime = explode(<span class="charliteral">&#39;:&#39;</span>, $testElapsedTime);
<a name="l00385"></a>00385                 $testElapsedTime = implode(<span class="stringliteral">&#39;, &#39;</span>, $testElapsedTime);
<a name="l00386"></a>00386                 $sectionElapsedTime = $this-&gt;getElapsedTime(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>,$sectionId);
<a name="l00387"></a>00387                 $sectionElapsedTime = explode(<span class="charliteral">&#39;:&#39;</span>, $sectionElapsedTime);
<a name="l00388"></a>00388                 $sectionElapsedTime = implode(<span class="stringliteral">&#39;, &#39;</span>, $sectionElapsedTime);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390                 $testTime = $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_testduration&#39;</span>];
<a name="l00391"></a>00391                 $testTime = explode(<span class="charliteral">&#39;:&#39;</span>, $testTime);
<a name="l00392"></a>00392                 $testTime = implode(<span class="stringliteral">&#39;, &#39;</span>, $testTime);
<a name="l00393"></a>00393                 
<a name="l00394"></a>00394                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>]) {
<a name="l00395"></a>00395                     $sectionTime = mysql_fetch_array(mysql_query(<span class="stringliteral">&quot;SELECT `quiz_sectiontimelimit` FROM `quiz_sections` WHERE `page_modulecomponentid` = &#39;{$this-&gt;quizId}&#39; AND `quiz_sectionid` = &#39;$sectionId&#39;&quot;</span>));
<a name="l00396"></a>00396                 
<a name="l00397"></a>00397                     $sectionTime = $sectionTime[0];
<a name="l00398"></a>00398                     $sectionTime = explode(<span class="charliteral">&#39;:&#39;</span>, $sectionTime);
<a name="l00399"></a>00399                     $sectionTime = implode(<span class="stringliteral">&#39;, &#39;</span>, $sectionTime);             
<a name="l00400"></a>00400                 $scripts[] = <span class="stringliteral">&quot;var sectionTimer = new JSTimer(&#39;sectionTimerContainer&#39;, $sectionElapsedTime);\nsectionTimer.addTickHandler($sectionTime, forceQuizSubmit)&quot;</span>;
<a name="l00401"></a>00401                 }
<a name="l00402"></a>00402 
<a name="l00403"></a>00403 
<a name="l00404"></a>00404                 $scripts[] = <span class="stringliteral">&quot;var testTimer = new JSTimer(&#39;testTimerContainer&#39;, $testElapsedTime);\ntestTimer.addTickHandler($testTime, forceQuizSubmit)&quot;</span>;
<a name="l00405"></a>00405                 
<a name="l00406"></a>00406                 $divs = array();
<a name="l00407"></a>00407                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_showquiztimer&#39;</span>]) {
<a name="l00408"></a>00408 
<a name="l00409"></a>00409                         $divs[] = <span class="stringliteral">&#39;&lt;div id=&quot;testTimerContainer&quot; class=&quot;quiz_testtimer&quot;&gt;Total Quiz Time Elapsed: &lt;/div&gt;&#39;</span>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411                 }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_showpagetimer&#39;</span>]) {
<a name="l00414"></a>00414                         $divs[] = <span class="stringliteral">&#39;&lt;div id=&quot;pageTimerContainer&quot; class=&quot;quiz_pagetimer&quot;&gt;&lt;/div&gt;&#39;</span>;
<a name="l00415"></a>00415                         $scripts[] = <span class="stringliteral">&quot;var pageTimer = new JSTimer(&#39;pageTimerContainer&#39;, 0, 0, 0);\n&quot;</span>;
<a name="l00416"></a>00416                 }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418                 $sectionRow = <a class="code" href="quizedit_8php.html#a30d3dff6b519adb307a50b336e5a553c">getSectionRow</a>($this-&gt;quizId, $sectionId);
<a name="l00419"></a>00419                 <span class="keywordflow">if</span> ($sectionRow[<span class="stringliteral">&#39;quiz_sectionshowlimit&#39;</span>]) {
<a name="l00420"></a>00420                         $sectionRow = <a class="code" href="quizedit_8php.html#a30d3dff6b519adb307a50b336e5a553c">getSectionRow</a>($this-&gt;quizId,$sectionId);
<a name="l00421"></a>00421                         $limit = $sectionRow[<span class="stringliteral">&#39;quiz_sectiontimelimit&#39;</span>];
<a name="l00422"></a>00422                         $divs[] = <span class="stringliteral">&#39;&lt;div id=&quot;pageTimerlimit&quot; class=&quot;quiz_limit&quot;&gt;Section Limit: &#39;</span> . $limit . <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00423"></a>00423                         $divs[] = <span class="stringliteral">&#39;&lt;div id=&quot;sectionTimerContainer&quot; class=&quot;quiz_testtimer&quot;&gt;Section Time Elapsed: &lt;/div&gt;&#39;</span>;
<a name="l00424"></a>00424                 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426                 global <a class="code" href="icons_8lib_8php.html#aedb76478d4528f9a7238cb660ba23f41">$urlRequestRoot</a>, <a class="code" href="icons_8lib_8php.html#a0fa2c9191ec4f6bb08bd885031af226c">$cmsFolder</a>, <a class="code" href="common_8lib_8php.html#aff25c40f48b4e124ac84533f8dbd0b4d">$moduleFolder</a>;
<a name="l00427"></a>00427                 $timerScriptSrc = <span class="stringliteral">&quot;$urlRequestRoot/$cmsFolder/$moduleFolder/quiz/timer.js&quot;</span>;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429                 <span class="keywordflow">if</span> (count($divs)) {
<a name="l00430"></a>00430                         $divs = implode(<span class="stringliteral">&quot;\n&quot;</span>, $divs);
<a name="l00431"></a>00431                         $scripts = implode(<span class="stringliteral">&quot;\n&quot;</span>, $scripts);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433                         $timerScript = &lt;&lt;&lt;TIMERSCRIPT
<a name="l00434"></a>00434                                 &lt;script <a class="code" href="cms_2templates_2blue__banks_2index_8php.html#a5b4586081f28ba5c2b7326fc2d4ca512">type</a>=<span class="stringliteral">&quot;text/javascript&quot;</span> src=<span class="stringliteral">&quot;$timerScriptSrc&quot;</span>&gt;&lt;/script&gt;
<a name="l00435"></a>00435                                 $divs
<a name="l00436"></a>00436                                 &lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;
<a name="l00437"></a>00437                                         <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> forceQuizSubmit() {
<a name="l00438"></a>00438                                                 alert(<span class="stringliteral">&quot;Your time is up. Please click Ok to submit the quiz. If you do not submit within 30 seconds, your quiz will expire, and your answers to this page will not be recorded.&quot;</span>);
<a name="l00439"></a>00439                                                 var quizForm = document.getElementById(<span class="stringliteral">&#39;quizForm&#39;</span>);
<a name="l00440"></a>00440                                                 var submitButton = document.getElementById(<span class="stringliteral">&#39;btnSubmit&#39;</span>);
<a name="l00441"></a>00441                                                 submitButton.type = <span class="stringliteral">&#39;hidden&#39;</span>;
<a name="l00442"></a>00442                                                 quizForm.submit();
<a name="l00443"></a>00443                                         }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445                                         $scripts
<a name="l00446"></a>00446                                 &lt;/script&gt;
<a name="l00447"></a>00447 TIMERSCRIPT;
<a name="l00448"></a>00448                 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450                 <span class="keywordflow">return</span> $timerScript;
<a name="l00451"></a>00451         }
<a name="l00452"></a>00452 
<a name="l00458"></a>00458         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> formatQuestion($questionRow, $questionNumber = -1) {
<a name="l00459"></a>00459                 $questionType = $questionRow[<span class="stringliteral">&#39;quiz_questiontype&#39;</span>];
<a name="l00460"></a>00460                 <span class="keywordflow">if</span> ($questionType == <span class="stringliteral">&#39;subjective&#39;</span>) {
<a name="l00461"></a>00461                         $fieldName = <span class="stringliteral">&#39;txtAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>];
<a name="l00462"></a>00462                         $answer = <span class="stringliteral">&#39;&lt;textarea rows=&quot;6&quot; cols=&quot;36&quot; name=&quot;&#39;</span> . $fieldName . <span class="stringliteral">&#39;&quot; id=&quot;&#39;</span> . $fieldName . <span class="stringliteral">&#39;&quot;&gt;&lt;/textarea&gt;&#39;</span>;
<a name="l00463"></a>00463                 }
<a name="l00464"></a>00464                 <span class="keywordflow">else</span> {
<a name="l00465"></a>00465                         $optionList = <a class="code" href="quizedit_8php.html#abbcd2bc9f89fbd603b8f510e6d122c32">getQuestionOptionList</a>($this-&gt;quizId, $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>], $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>]);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467                         $answer = <span class="stringliteral">&#39;&lt;table class=&quot;objectivecontainer&quot; width=&quot;100%&quot;&gt;&#39;</span>;
<a name="l00468"></a>00468                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($optionList); ++$i) {
<a name="l00469"></a>00469                                 $fieldType = ($questionType == <span class="stringliteral">&#39;sso&#39;</span> ? <span class="stringliteral">&#39;radio&#39;</span> : <span class="stringliteral">&#39;checkbox&#39;</span>);
<a name="l00470"></a>00470                                 $fieldName = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00471"></a>00471                                 $fieldId = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00472"></a>00472                                 <span class="keywordflow">if</span> ($questionType == <span class="stringliteral">&#39;sso&#39;</span>) {
<a name="l00473"></a>00473                                         $fieldName = <span class="stringliteral">&#39;optAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>];
<a name="l00474"></a>00474                                         $fieldId = $fieldName . <span class="charliteral">&#39;_&#39;</span> . $optionList[$i][<span class="stringliteral">&#39;quiz_optionid&#39;</span>];
<a name="l00475"></a>00475                                 }
<a name="l00476"></a>00476                                 elseif ($questionType == <span class="stringliteral">&#39;mso&#39;</span>) {
<a name="l00477"></a>00477                                         $fieldName = <span class="stringliteral">&#39;chkAnswer&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $questionRow[<span class="stringliteral">&#39;quiz_questionid&#39;</span>] . <span class="charliteral">&#39;_&#39;</span> . $optionList[$i][<span class="stringliteral">&#39;quiz_optionid&#39;</span>];
<a name="l00478"></a>00478                                         $fieldId = $fieldName;
<a name="l00479"></a>00479                                 }
<a name="l00480"></a>00480                                 $answer .= <span class="stringliteral">&quot;&lt;tr&gt;&lt;td width=\&quot;24\&quot;&gt;&lt;input type=\&quot;$fieldType\&quot; name=\&quot;$fieldName\&quot; id=\&quot;$fieldId\&quot; value=\&quot;{$optionList[$i][&#39;quiz_optionid&#39;]}\&quot; /&gt; &lt;/td&gt;&lt;td&gt;&lt;label for=\&quot;$fieldId\&quot;&gt; {$optionList[$i][&#39;quiz_optiontext&#39;]}&lt;/label&gt;&lt;/td&gt;&lt;/tr&gt;\n&quot;</span>;
<a name="l00481"></a>00481                         }
<a name="l00482"></a>00482                         $answer .= <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>;
<a name="l00483"></a>00483                 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485                 $hiddenFieldName = <span class="stringliteral">&quot;hdnQuestion{$questionRow[&#39;quiz_sectionid&#39;]}_{$questionRow[&#39;quiz_questionid&#39;]}&quot;</span>;
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                 $questionDesc = $questionRow[<span class="stringliteral">&#39;quiz_question&#39;</span>];
<a name="l00488"></a>00488                 <span class="keywordflow">if</span> ($questionNumber &gt; 0) $questionDesc = $questionNumber . <span class="stringliteral">&#39;) &#39;</span> . $questionDesc;
<a name="l00489"></a>00489 
<a name="l00490"></a>00490                 global <a class="code" href="common_8lib_8php.html#af6e6b8785607da4a06f0ab2ebd67e518">$sourceFolder</a>, $moduleFolder;
<a name="l00491"></a>00491                 require_once($sourceFolder.<span class="stringliteral">&quot;/latexRender.class.php&quot;</span>);
<a name="l00492"></a>00492                 $render = <span class="keyword">new</span> <a class="code" href="classlatexrender.html">latexrender</a>();
<a name="l00493"></a>00493                 $questionDesc = $render-&gt;transform($questionDesc);
<a name="l00494"></a>00494                 $answer = $render-&gt;transform($answer);
<a name="l00495"></a>00495 
<a name="l00496"></a>00496                 <span class="keywordflow">return</span> &lt;&lt;&lt;QUESTIONFORM
<a name="l00497"></a>00497                         &lt;input type=<span class="stringliteral">&quot;hidden&quot;</span> <a class="code" href="template_8lib_8php.html#a824aa20276005f0889ccb9ff6f1c5efd">name</a>=<span class="stringliteral">&quot;$hiddenFieldName&quot;</span> <span class="keywordtype">id</span>=<span class="stringliteral">&quot;$hiddenFieldName&quot;</span> value=<span class="stringliteral">&quot;&quot;</span> /&gt;
<a name="l00498"></a>00498                         &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;quiz_questioncontainer&quot;</span>&gt;
<a name="l00499"></a>00499                                 {$questionDesc}
<a name="l00500"></a>00500                         &lt;/div&gt;
<a name="l00501"></a>00501                         &lt;div <span class="keyword">class</span>=<span class="stringliteral">&quot;quiz_answercontainer&quot;</span>&gt;
<a name="l00502"></a>00502                                 $answer
<a name="l00503"></a>00503                         &lt;/div&gt;
<a name="l00504"></a>00504 QUESTIONFORM;
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506 
<a name="l00510"></a>00510         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> formatNextPage(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId = -1) {
<a name="l00511"></a>00511                 $questionCount = $this-&gt;quizRow[<span class="stringliteral">&#39;quiz_questionsperpage&#39;</span>];
<a name="l00512"></a>00512                 $questionQuery = <span class="stringliteral">&quot;SELECT `quiz_questions`.`quiz_sectionid` AS `quiz_sectionid`, `quiz_questions`.`quiz_questionid` AS `quiz_questionid`, `quiz_question`, `quiz_questiontype`, `quiz_questionweight`, `quiz_answermaxlength`, `quiz_rightanswer`, `quiz_questionviewtime`, `quiz_answersubmittime` &quot;</span> .
<a name="l00513"></a>00513                                 <span class="stringliteral">&quot;FROM `quiz_questions`, `quiz_answersubmissions` WHERE &quot;</span> .
<a name="l00514"></a>00514                                 <span class="stringliteral">&quot;`quiz_questions`.`page_modulecomponentid` = {$this-&gt;quizId} AND &quot;</span> .
<a name="l00515"></a>00515                                 <span class="stringliteral">&quot;`quiz_answersubmissions`.`user_id` = $userId AND &quot;</span> .
<a name="l00516"></a>00516                                 <span class="stringliteral">&quot;`quiz_questions`.`page_modulecomponentid` = `quiz_answersubmissions`.`page_modulecomponentid` AND &quot;</span> .
<a name="l00517"></a>00517                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_sectionid` = `quiz_answersubmissions`.`quiz_sectionid` AND &quot;</span> .
<a name="l00518"></a>00518                                 <span class="stringliteral">&quot;`quiz_questions`.`quiz_questionid` = `quiz_answersubmissions`.`quiz_questionid` AND &quot;</span> .
<a name="l00519"></a>00519                                 <span class="stringliteral">&quot;`quiz_answersubmissions`.`quiz_answersubmittime` IS NULL &quot;</span>;
<a name="l00520"></a>00520                 <span class="keywordflow">if</span> ($this-&gt;quizRow[<span class="stringliteral">&#39;quiz_allowsectionrandomaccess&#39;</span>] == 1)
<a name="l00521"></a>00521                         $questionQuery .= <span class="stringliteral">&quot;AND `quiz_answersubmissions`.`quiz_sectionid` = $sectionId &quot;</span>;
<a name="l00522"></a>00522                 $questionQuery .= <span class="stringliteral">&quot;ORDER BY `quiz_answersubmissions`.`quiz_questionrank` &quot;</span> .
<a name="l00523"></a>00523                                 <span class="stringliteral">&quot;LIMIT $questionCount&quot;</span>;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525                 $questionResult = mysql_query($questionQuery);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527                 $questionNumber = 1;
<a name="l00528"></a>00528                 $questionPage = $this-&gt;getTimerHtml(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId);
<a name="l00529"></a>00529                 $questionPage .= <span class="stringliteral">&#39;&lt;form name=&quot;quizquestions&quot; id=&quot;quizForm&quot; method=&quot;POST&quot; action=&quot;./+view&#39;</span> . ($sectionId == -1 ? <span class="stringliteral">&#39;&#39;</span> : <span class="stringliteral">&#39;&amp;sectionid=&#39;</span> . $sectionId) . <span class="stringliteral">&#39;&quot; onsubmit=&quot;return confirm(\&#39;Are you sure you wish to submit this page?\&#39;)&quot;&gt;&#39;</span>;
<a name="l00530"></a>00530                 <span class="keywordflow">while</span> ($questionRow = mysql_fetch_assoc($questionResult)) {
<a name="l00531"></a>00531                         <span class="keywordflow">if</span> (is_null($questionRow[<span class="stringliteral">&#39;quiz_questionviewtime&#39;</span>]))
<a name="l00532"></a>00532                                 mysql_query(<span class="stringliteral">&quot;UPDATE `quiz_answersubmissions` SET `quiz_questionviewtime` = NOW() WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = {$questionRow[&#39;quiz_sectionid&#39;]} AND `quiz_questionid` = {$questionRow[&#39;quiz_questionid&#39;]}&quot;</span>);
<a name="l00533"></a>00533                         $questionPage .= $this-&gt;formatQuestion($questionRow, $questionNumber);
<a name="l00534"></a>00534                         ++$questionNumber;
<a name="l00535"></a>00535                 }
<a name="l00536"></a>00536                 $questionPage .= <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;btnSubmit&quot; id=&quot;btnSubmit&quot; value=&quot;Submit&quot; /&gt;&#39;</span>;
<a name="l00537"></a>00537                 $questionPage .= <span class="stringliteral">&#39;&lt;/form&gt;&#39;</span>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539                 $questionPage .= &lt;&lt;&lt;QUESTIONPAGESCRIPT
<a name="l00540"></a>00540                 &lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span>&gt;
<a name="l00541"></a>00541                         <span class="comment">// make opt buttons uncheckable</span>
<a name="l00542"></a>00542                         var inputFields = document.getElementById(<span class="stringliteral">&#39;quizForm&#39;</span>).getElementsByTagName(<span class="stringliteral">&#39;input&#39;</span>);
<a name="l00543"></a>00543                         <span class="keywordflow">for</span> (var i = 0; i &lt; inputFields.length; ++i) {
<a name="l00544"></a>00544                                 <span class="keywordflow">if</span> (inputFields[i].type == <span class="stringliteral">&#39;radio&#39;</span>)
<a name="l00545"></a>00545                                         inputFields[i].onclick = <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a>(e) {
<a name="l00546"></a>00546                                                 <span class="keywordflow">if</span> (this.rel == <span class="stringliteral">&#39;checked&#39;</span>) {
<a name="l00547"></a>00547                                                         this.checked = <span class="keyword">false</span>;
<a name="l00548"></a>00548                                                         this.rel = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00549"></a>00549                                                 }
<a name="l00550"></a>00550                                                 <span class="keywordflow">else</span> {
<a name="l00551"></a>00551                                                         var elements = document.getElementsByName(this.<a class="code" href="template_8lib_8php.html#a824aa20276005f0889ccb9ff6f1c5efd">name</a>);
<a name="l00552"></a>00552                                                         <span class="keywordflow">for</span> (var i = 0; i &lt; elements.length; ++i) {
<a name="l00553"></a>00553                                                                 elements[i].rel = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00554"></a>00554                                                                 elements[i].checked = <span class="keyword">false</span>;
<a name="l00555"></a>00555                                                         }
<a name="l00556"></a>00556                                                         this.checked = <span class="keyword">true</span>;
<a name="l00557"></a>00557                                                         this.rel = <span class="stringliteral">&#39;checked&#39;</span>;
<a name="l00558"></a>00558                                                 }
<a name="l00559"></a>00559                                         };
<a name="l00560"></a>00560                         }
<a name="l00561"></a>00561                 &lt;/script&gt;
<a name="l00562"></a>00562 QUESTIONPAGESCRIPT;
<a name="l00563"></a>00563                 <span class="keywordflow">return</span> $questionPage;
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565 
<a name="l00572"></a>00572         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> countAttemptedQuestions(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>, $sectionId = -1) {
<a name="l00573"></a>00573                 $countQuery = <span class="stringliteral">&quot;SELECT COUNT(*) FROM `quiz_submittedanswers` WHERE `page_modulecomponentid` = {$this-&gt;quizId}&quot;</span>;
<a name="l00574"></a>00574                 <span class="keywordflow">if</span> ($sectionId != -1)
<a name="l00575"></a>00575                         $countQuery .= <span class="stringliteral">&quot; AND `quiz_sectionid` = $sectionId&quot;</span>;
<a name="l00576"></a>00576                 $countQuery .= <span class="stringliteral">&quot; `user_id` = $userId AND `quiz_answersubmittime` IS NOT NULL&quot;</span>;
<a name="l00577"></a>00577                 $countResult = mysql_query($countQuery);
<a name="l00578"></a>00578                 <span class="keywordflow">if</span> (!$countResult) {
<a name="l00579"></a>00579                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not retrieve user attempt information.&#39;</span>);
<a name="l00580"></a>00580                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00581"></a>00581                 }
<a name="l00582"></a>00582                 $countRow = mysql_fetch_row($countResult);
<a name="l00583"></a>00583                 <span class="keywordflow">return</span> $countRow[0];
<a name="l00584"></a>00584         }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getSectionQuestions($sectionRow) {
<a name="l00587"></a>00587                 $questionTypes = array_keys(<a class="code" href="quizedit_8php.html#ac5255a0fd645a9cf8f1a197a0c5bd561">getQuestionTypes</a>());
<a name="l00588"></a>00588                 $sectionId = $sectionRow[<span class="stringliteral">&#39;quiz_sectionid&#39;</span>];
<a name="l00589"></a>00589 
<a name="l00590"></a>00590                 <span class="keywordflow">if</span> ($sectionRow[<span class="stringliteral">&#39;quiz_sectionquestionshuffled&#39;</span>] == 0) {
<a name="l00591"></a>00591                         $limit = 0;
<a name="l00592"></a>00592                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($questionTypes); ++$i)
<a name="l00593"></a>00593                                 $limit += $sectionRow[<span class="stringliteral">&quot;quiz_section{$questionTypes[$i]}count&quot;</span>];
<a name="l00594"></a>00594                         $questionQuery = <span class="stringliteral">&quot;SELECT `quiz_questionid` FROM `quiz_questions` WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = $sectionId ORDER BY `quiz_questionrank` LIMIT $limit&quot;</span>;
<a name="l00595"></a>00595                 }
<a name="l00596"></a>00596                 <span class="keywordflow">else</span> {
<a name="l00597"></a>00597                         $questionIdQueries = array();
<a name="l00598"></a>00598                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($questionTypes); ++$i) {
<a name="l00599"></a>00599                                 $limit = $sectionRow[<span class="stringliteral">&quot;quiz_section{$questionTypes[$i]}count&quot;</span>];
<a name="l00600"></a>00600                                 <span class="keywordflow">if</span> ($limit) {
<a name="l00601"></a>00601                                         $questionIdQueries[] = 
<a name="l00602"></a>00602                                                 <span class="stringliteral">&quot;(SELECT `quiz_questionid` FROM `quiz_questions` WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = $sectionId AND `quiz_questiontype` = &#39;{$questionTypes[$i]}&#39; ORDER BY RAND() LIMIT $limit)&quot;</span>;
<a name="l00603"></a>00603                                 }
<a name="l00604"></a>00604                         }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606                         $questionQuery = <span class="stringliteral">&quot;SELECT `quiz_questionid` FROM (&quot;</span> . implode(<span class="stringliteral">&#39; UNION &#39;</span>, $questionIdQueries) . <span class="stringliteral">&quot;) AS `questions` ORDER BY RAND()&quot;</span>;
<a name="l00607"></a>00607                 }
<a name="l00608"></a>00608 
<a name="l00609"></a>00609                 $questionIds = array();
<a name="l00610"></a>00610                 $questionResult = mysql_query($questionQuery) or die(mysql_error());
<a name="l00611"></a>00611                 while ($questionRow = mysql_fetch_row($questionResult))
<a name="l00612"></a>00612                         $questionIds[] = $questionRow[0];
<a name="l00613"></a>00613                 <a class="code" href="search_structure_8php.html#af7449f4e1bb7fd701d8a3ead5f0da5a1">return</a> $questionIds;
<a name="l00614"></a>00614         }
<a name="l00615"></a>00615 
<a name="l00622"></a>00622         private <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> checkQuizCompleted(<a class="code" href="index_8php.html#a84651f4070d04080f6c5fd3c98cc9104">$userId</a>) {
<a name="l00623"></a>00623                 $countQuery = <span class="stringliteral">&quot;SELECT COUNT(*) FROM `quiz_userattempts`, `quiz_sections` WHERE &quot;</span> .
<a name="l00624"></a>00624                                 <span class="stringliteral">&quot;`quiz_sections`.`page_modulecomponentid` = `quiz_userattempts`.`page_modulecomponentid` AND &quot;</span> .
<a name="l00625"></a>00625                                 <span class="stringliteral">&quot;`quiz_sections`.`quiz_sectionid` = `quiz_userattempts`.`quiz_sectionid` AND &quot;</span> .
<a name="l00626"></a>00626                                 <span class="stringliteral">&quot;`quiz_sections`.`page_modulecomponentid` = {$this-&gt;quizId} AND &quot;</span> .
<a name="l00627"></a>00627                                 <span class="stringliteral">&quot;`quiz_userattempts`.`user_id` = $userId AND &quot;</span> .
<a name="l00628"></a>00628                                 <span class="stringliteral">&quot;`quiz_submissiontime` IS NOT NULL&quot;</span>;
<a name="l00629"></a>00629                 $countResult = mysql_query($countQuery);
<a name="l00630"></a>00630                 <span class="keywordflow">if</span> (!$countResult) {
<a name="l00631"></a>00631                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not fetch section information.&#39;</span>);
<a name="l00632"></a>00632                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00633"></a>00633                 }
<a name="l00634"></a>00634                 $countRow = mysql_fetch_row($countResult);
<a name="l00635"></a>00635                 $completedCount = $countRow[0];
<a name="l00636"></a>00636                 $countQuery = <span class="stringliteral">&quot;SELECT COUNT(*) FROM `quiz_sections` WHERE `page_modulecomponentid` = {$this-&gt;quizId}&quot;</span>;
<a name="l00637"></a>00637                 $countResult = mysql_query($countQuery);
<a name="l00638"></a>00638                 $countRow = mysql_fetch_row($countResult);
<a name="l00639"></a>00639                 <span class="keywordflow">return</span> $countRow[0] == $completedCount;
<a name="l00640"></a>00640         }
<a name="l00641"></a>00641 
<a name="l00647"></a>00647         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> isValidId(<a class="code" href="iconmanagement_8lib_8php.html#ae97941710d863131c700f069b109991e">$id</a>) {
<a name="l00648"></a>00648                 <span class="keywordflow">return</span> isset(<a class="code" href="iconmanagement_8lib_8php.html#ae97941710d863131c700f069b109991e">$id</a>) &amp;&amp; is_numeric(<a class="code" href="iconmanagement_8lib_8php.html#ae97941710d863131c700f069b109991e">$id</a>) &amp;&amp; <a class="code" href="iconmanagement_8lib_8php.html#ae97941710d863131c700f069b109991e">$id</a> &gt; 0;
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650 
<a name="l00655"></a>00655         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> markSectionCompleted($userId, $sectionId = -1) {
<a name="l00656"></a>00656                 <span class="keywordflow">if</span> ($sectionId == -1) {
<a name="l00657"></a>00657                         $sections = <a class="code" href="quizedit_8php.html#aa6048c9e9a7e86f07a5099a0cf660bd3">getSectionList</a>($this-&gt;quizId);
<a name="l00658"></a>00658                         $allOk = <span class="keyword">true</span>;
<a name="l00659"></a>00659                         <span class="keywordflow">for</span> ($i = 0; $i &lt; count($sections); ++$i)
<a name="l00660"></a>00660                                 $allOk = $this-&gt;markSectionCompleted($userId, $sections[$i][<span class="stringliteral">&#39;quiz_sectionid&#39;</span>]) &amp;&amp; $allOk;
<a name="l00661"></a>00661                         <span class="keywordflow">return</span> $allOk;
<a name="l00662"></a>00662                 }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                 $attemptRow = <a class="code" href="quizview_8php.html#a52a9a44d1bab5deac59f0d01c102a48e">getAttemptRow</a>($this-&gt;quizId, $sectionId, $userId);
<a name="l00665"></a>00665                 <span class="keywordflow">if</span> (is_null($attemptRow[<span class="stringliteral">&#39;quiz_submissiontime&#39;</span>])) {
<a name="l00666"></a>00666                         <span class="comment">// Check if all questions for this section have been completed, if yes, set quiz_submissiontime and return true</span>
<a name="l00667"></a>00667                         $questionQuery = <span class="stringliteral">&quot;SELECT COUNT(*) FROM `quiz_answersubmissions` WHERE &quot;</span> .
<a name="l00668"></a>00668                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = $sectionId AND `user_id` = $userId AND `quiz_answersubmittime` IS NULL&quot;</span>;
<a name="l00669"></a>00669                         $questionResult = mysql_query($questionQuery);
<a name="l00670"></a>00670                         $questionRow = mysql_fetch_row($questionResult);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672                         <span class="keywordflow">if</span> ($questionRow[0] != 0)
<a name="l00673"></a>00673                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675                         $updateQuery = <span class="stringliteral">&quot;UPDATE `quiz_userattempts` SET `quiz_submissiontime` = NOW() WHERE `page_modulecomponentid` = $this-&gt;quizId AND `quiz_sectionid` = $sectionId AND `user_id` = $userId&quot;</span>;
<a name="l00676"></a>00676                         <span class="keywordflow">if</span> (mysql_query($updateQuery))
<a name="l00677"></a>00677                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00678"></a>00678                         <span class="keywordflow">else</span> {
<a name="l00679"></a>00679                                 <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not mark section as completed.&#39;</span>);
<a name="l00680"></a>00680                                 <span class="keywordflow">return</span> -1;
<a name="l00681"></a>00681                         }
<a name="l00682"></a>00682                 }
<a name="l00683"></a>00683                 <span class="keywordflow">else</span>
<a name="l00684"></a>00684                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686 
<a name="l00692"></a>00692         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> markQuizCompleted($userId) {
<a name="l00693"></a>00693                 $updateQueries = array(
<a name="l00694"></a>00694                         <span class="stringliteral">&quot;UPDATE `quiz_answersubmissions` SET `quiz_submittedanswer` = &#39;&#39;, `quiz_answersubmittime` = NOW() WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId AND `quiz_answersubmittime` IS NULL&quot;</span>,
<a name="l00695"></a>00695                         <span class="stringliteral">&quot;UPDATE `quiz_userattempts` SET `quiz_submissiontime` = NOW() WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId AND `quiz_submissiontime` IS NULL&quot;</span>
<a name="l00696"></a>00696                 );
<a name="l00697"></a>00697 
<a name="l00698"></a>00698                 <span class="keywordflow">if</span> (!mysql_query($updateQueries[0]) || !mysql_query($updateQueries[1])) {
<a name="l00699"></a>00699                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Error. Could not mark quiz as completed.&#39;</span>);
<a name="l00700"></a>00700                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00701"></a>00701                 }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705 
<a name="l00711"></a>00711         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getElapsedTime($userId, $sectionId = -1) {
<a name="l00712"></a>00712                 <span class="keywordflow">if</span> ($sectionId &lt; 0)
<a name="l00713"></a>00713                         $elapsedQuery = <span class="stringliteral">&quot;SELECT TIMEDIFF(NOW(), MIN(`quiz_attemptstarttime`)) FROM `quiz_userattempts` WHERE &quot;</span> .
<a name="l00714"></a>00714                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00715"></a>00715                 <span class="keywordflow">else</span>
<a name="l00716"></a>00716                         $elapsedQuery = <span class="stringliteral">&quot;SELECT TIMEDIFF(NOW(), `quiz_attemptstarttime`) FROM `quiz_userattempts` WHERE &quot;</span> .
<a name="l00717"></a>00717                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = $sectionId AND `user_id` = $userId&quot;</span>;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719                 $elapsedResult = mysql_query($elapsedQuery);
<a name="l00720"></a>00720                 <span class="keywordflow">if</span> (!$elapsedResult)
<a name="l00721"></a>00721                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Error. &#39;</span> . $elapsedQuery . <span class="stringliteral">&#39;&lt;br /&gt;&#39;</span> . mysql_error());
<a name="l00722"></a>00722                 $elapsedRow = mysql_fetch_row($elapsedResult);
<a name="l00723"></a>00723                 <span class="keywordflow">return</span> $elapsedRow[0];
<a name="l00724"></a>00724         }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> getRemainingTime($userId, $sectionId = -1) {
<a name="l00727"></a>00727                 <span class="keywordflow">if</span> ($sectionId &lt; 0) {
<a name="l00728"></a>00728                         $remainingQuery = <span class="stringliteral">&quot;SELECT TIMEDIFF(NOW(), ADDTIME(MIN(`quiz_attemptstarttime`), &#39;{$this-&gt;quizRow[&#39;quiz_testduration&#39;]}&#39;)) FROM `quiz_userattempts` WHERE &quot;</span> .
<a name="l00729"></a>00729                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00730"></a>00730                 }
<a name="l00731"></a>00731                 <span class="keywordflow">else</span> {
<a name="l00732"></a>00732                         $remainingQuery = <span class="stringliteral">&quot;SELECT TIMEDIFF(NOW(), ADDTIME(`quiz_attemptstarttime`, &#39;{$this-&gt;quizRow[&#39;quiz_testduration&#39;]}&#39;)) FROM `quiz_userattempts` WHERE &quot;</span> .
<a name="l00733"></a>00733                                         <span class="stringliteral">&quot;`page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00734"></a>00734                 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                 $remainingResult = mysql_query($remainingQuery);
<a name="l00737"></a>00737                 $remainingRow = mysql_fetch_row($remainingResult);
<a name="l00738"></a>00738                 <span class="keywordflow">return</span> $remainingRow[0];
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740 
<a name="l00748"></a>00748         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> checkUserTimedOut($userId, $sectionId = -1, $offset = <span class="stringliteral">&#39;0 SECOND&#39;</span>) {
<a name="l00749"></a>00749                 <span class="keywordflow">if</span> ($sectionId &lt; 0) {
<a name="l00750"></a>00750                         <span class="comment">// Check if the quiz has timed out:</span>
<a name="l00751"></a>00751                         <span class="comment">//  Find the earliest attempt start time, add quiz duration to it</span>
<a name="l00752"></a>00752                         <span class="comment">//      add offset to now, and compare</span>
<a name="l00753"></a>00753                         $timeoutQuery = <span class="stringliteral">&quot;SELECT IF(DATE_SUB(NOW(), INTERVAL $offset) &gt; ADDTIME(MIN(`quiz_attemptstarttime`), &#39;{$this-&gt;quizRow[&#39;quiz_testduration&#39;]}&#39;), 1, 0) AS `quiz_expired` FROM &quot;</span> .
<a name="l00754"></a>00754                                         <span class="stringliteral">&quot;`quiz_userattempts` WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00755"></a>00755                 }
<a name="l00756"></a>00756                 <span class="keywordflow">else</span> {
<a name="l00757"></a>00757                         $sectionRow = <a class="code" href="quizedit_8php.html#a30d3dff6b519adb307a50b336e5a553c">getSectionRow</a>($this-&gt;quizId, $sectionId);
<a name="l00758"></a>00758 
<a name="l00759"></a>00759                         <span class="keywordflow">if</span> ($sectionRow[<span class="stringliteral">&#39;quiz_sectiontimelimit&#39;</span>] == <span class="stringliteral">&#39;00:00:00&#39;</span>)
<a name="l00760"></a>00760                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762                         $timeoutQuery = <span class="stringliteral">&quot;SELECT IF(DATE_SUB(NOW(), INTERVAL $offset) &gt; ADDTIME(`quiz_attemptstarttime`, &#39;{$sectionRow[&#39;quiz_sectiontimelimit&#39;]}&#39;), 1, 0) AS `quiz_expired` FROM &quot;</span> .
<a name="l00763"></a>00763                                         <span class="stringliteral">&quot;`quiz_userattempts` WHERE `page_modulecomponentid` = {$this-&gt;quizId} AND `quiz_sectionid` = $sectionId AND `user_id` = $userId&quot;</span>;
<a name="l00764"></a>00764                 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766                 $timeoutResult = mysql_query($timeoutQuery);
<a name="l00767"></a>00767                 <span class="keywordflow">if</span> (!$timeoutResult) {
<a name="l00768"></a>00768                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not retrieve time information.&#39;</span>);
<a name="l00769"></a>00769                         <span class="keywordflow">return</span> -1;
<a name="l00770"></a>00770                 }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772                 $timeoutRow = mysql_fetch_row($timeoutResult);
<a name="l00773"></a>00773                 <span class="keywordflow">if</span> (is_null($timeoutRow[0])) {
<a name="l00774"></a>00774                         <span class="comment">// An invalid Section ID was passed =&gt; we could not find a row for the user for that</span>
<a name="l00775"></a>00775                         <span class="comment">// Section ID. assume he timed out</span>
<a name="l00776"></a>00776                         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00777"></a>00777                 }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779                 <span class="keywordflow">return</span> $timeoutRow[0];
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781 
<a name="l00788"></a>00788         <span class="keyword">private</span> <a class="code" href="cms_2templates_2pv3_2index_8php.html#a3d59d9110a163fdc9c81f6f02f628ea2">function</a> forceQuizCompleted($userId, $sectionId = -1) {
<a name="l00789"></a>00789                 $updateQuery = <span class="stringliteral">&quot;UPDATE `quiz_userattempts` SET `quiz_submissiontime` = NOW() WHERE `quiz_submissiontime` IS NULL AND `page_modulecomponentid` = {$this-&gt;quizId} AND `user_id` = $userId&quot;</span>;
<a name="l00790"></a>00790                 <span class="keywordflow">if</span> ($sectionId &gt;= 0)
<a name="l00791"></a>00791                         $updateQuery .= <span class="stringliteral">&quot; AND `quiz_sectionid` = $sectionId&quot;</span>;
<a name="l00792"></a>00792                 <span class="keywordflow">if</span> (!mysql_query($updateQuery)) {
<a name="l00793"></a>00793                         <a class="code" href="common_8lib_8php.html#a3ea290f0cbed066526d9d71cb416727e">displayerror</a>(<span class="stringliteral">&#39;Database Error. Could not mark quiz as completed.&#39;</span>);
<a name="l00794"></a>00794                         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00795"></a>00795                 }
<a name="l00796"></a>00796                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00797"></a>00797         }
<a name="l00798"></a>00798 };
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Jan 2 2011 04:55:32 for Pragyan CMS by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
